parameters:
  - name: buildConfiguration
    type: string
  - name: pool
    type: object
    default: []
  - name: dependsOn
    type: object
    default: null
  - name: artifactStem
    type: string
    default: ''
  - name: jobName
    type: string
    default: BuildAndPublishPGONuget
  - name: pgoProject
    type: string
    default: ''
  - name: pgoDefinition
    type: string
    default: ''
  - name: pgoVersionDl
    type: string
    default: ''
  - name: pgoPipelineId
    type: string
    default: ''

jobs:
- job: ${{ parameters.jobName }}
  ${{ if ne(length(parameters.pool), 0) }}:
    pool: ${{ parameters.pool }}
  dependsOn: ${{ parameters.dependsOn }}
  displayName: Package and Publish PGO Databases

  variables:
    artifactsPath: $(Build.SourcesDirectory)\Artifacts
    pgoToolsPath: $(Build.SourcesDirectory)\build\PGO
    nuspecPath: $(pgoToolsPath)\NuSpecs
    nuspecFilename: PGO.nuspec

  steps:
  - task: DownloadPipelineArtifact@2
    displayName: Download Final PGO Databases
    inputs:
      artifact: pgd-merged-${{ parameters.buildConfiguration }}${{ parameters.artifactStem }}
      downloadPath: $(artifactsPath)
      ${{ if ne(parameters.pgoProject, '') }}:
        buildType: specific
        project: ${{parameters.pgoProject}}
        definition: ${{parameters.pgoDefinition}}
        buildVersionToDownload: ${{parameters.pgoVersionDl}}
        pipelineId: ${{parameters.pgoPipelineId}}

  - task: NuGetAuthenticate@0
    inputs:
      nuGetServiceConnections: 'Terminal Public Artifact Feed'

  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 5.8.0'
    inputs:
      versionSpec: 5.8.0

  # In the Microsoft Azure DevOps tenant, NuGetCommand is ambiguous.
  # This should be `task: NuGetCommand@2`
  - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
    displayName: Restore NuGet packages for extraneous build actions
    inputs:
      command: restore
      feedsToUse: config
      configPath: NuGet.config
      restoreSolution: build/packages.config
      restoreDirectory: '$(Build.SourcesDirectory)\packages'

  - task: MSBuild@1
    displayName: 'Create PGO Nuget'
    inputs:
      solution: $(pgoToolsPath)\PGO.DB.proj
      msbuildArguments: '/t:CreatePGONuGet /p:PGOBuildMode=Instrument /p:PGDPathForAllArch=$(artifactsPath) /p:PGOOutputPath=$(Build.ArtifactStagingDirectory)'

  - publish: $(Build.ArtifactStagingDirectory)
    artifact: pgo-nupkg-${{ parameters.buildConfiguration }}${{ parameters.artifactStem }}
    displayName: "Publish Pipeline Artifact"

  - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
    displayName: 'NuGet push'
    inputs:
      command: push
      nuGetFeedType: external
      packagesToPush: $(Build.ArtifactStagingDirectory)/*.nupkg
      # The actual URL and PAT for this feed is configured at
      # https://microsoft.visualstudio.com/Dart/_settings/adminservices
      # This is the name of that connection
      publishFeedCredentials: 'Terminal Public Artifact Feed'
      feedsToUse: config
      nugetConfigPath: '$(Build.SourcesDirectory)/NuGet.config'
