trigger: none
pr: none

parameters:
  - name: buildPlatforms
    type: object
    default:
      - x64
      - arm64

variables:
  - name: runCodesignValidationInjectionBG
    value: false

#     0.0.yyMM.dd##
#     0.0.1904.0900
name: 0.0.$(Date:yyMM).$(Date:dd)$(Rev:rr)

# Run all unspecified phases on the Large pools
pool:
  ${{ if eq(variables['System.CollectionUri'], 'https://dev.azure.com/ms/') }}:
    name: SHINE-OSS-L
  ${{ if ne(variables['System.CollectionUri'], 'https://dev.azure.com/ms/') }}:
    name: SHINE-INT-L

stages:
  - stage: Build
    displayName: Build
    dependsOn: []
    condition: succeeded()
    jobs:
      - template: ./templates-v2/job-build-project.yml
        parameters:
          buildPlatforms: ${{ parameters.buildPlatforms }}
          buildConfigurations: [Release]
          buildEverything: true
          pgoBuildMode: Instrument
          artifactStem: -instrumentation

  - stage: RunPGO
    displayName: Run PGO
    dependsOn: [Build]
    condition: succeeded()
    jobs:
      - ${{ each platform in parameters.buildPlatforms }}:
        - template: ./templates-v2/job-run-pgo-tests.yml
          parameters:
            buildPlatform: ${{ platform }}
            buildConfiguration: Release
            artifactStem: -instrumentation

  - stage: FinalizePGO
    displayName: Finalize PGO and Publish
    dependsOn: [RunPGO]
    condition: succeeded()
    jobs:
      - template: ./templates-v2/job-pgo-merge-pgd.yml
        parameters:
          buildConfiguration: Release
          buildPlatforms: ${{ parameters.buildPlatforms }}
          artifactStem: -instrumentation

# - stage: Publish_PGO_Databases
#   displayName: Publish PGO databases
#   dependsOn: ['Build_x64']
#   jobs:
#     - template: ./templates/pgo-build-and-publish-nuget-job.yml
#       parameters:
#         pgoArtifact: 'PGO'
