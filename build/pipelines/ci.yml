trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*
  paths:
    exclude:
      - doc/*
      - samples/*
      - tools/*

pr:
  branches:
    include:
      - main
      - feature/*
  paths:
    exclude:
      - doc/*
      - samples/*
      - tools/*

parameters:
  - name: buildPlatforms
    type: object
    default:
      - x64
      - x86
      - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
        - arm64
  - name: testPlatforms
    type: object
    default:
      - x64
      - x86

variables:
  - name: runCodesignValidationInjectionBG
    value: false

#     0.0.yyMM.dd##
#     0.0.1904.0900
name: 0.0.$(Date:yyMM).$(Date:dd)$(Rev:rr)

stages:
  - stage: Audit_x64
    displayName: Audit Mode
    dependsOn: []
    condition: succeeded()
    jobs:
      - template: ./templates/build-console-audit-job.yml
        parameters:
          platform: x64

  - ${{ each platform in parameters.buildPlatforms }}:
    - stage: Build_${{ platform }}
      displayName: Build ${{ platform }}
      dependsOn: []
      condition: succeeded()
      jobs:
        - template: ./templates/build-console-ci.yml
          parameters:
            platform: ${{ platform }}

  - ${{ each platform in parameters.testPlatforms }}:
    - stage: Test_${{ platform }}
      displayName: Test ${{ platform }}
      dependsOn: [Build_${{ platform }}]
      condition: succeeded()
      jobs:
        - template: ./templates/test-console-ci.yml
          parameters:
            platform: ${{ platform }}

  - stage: Helix_x64
    displayName: Helix x64
    dependsOn: [Build_x64]
    condition: and(succeeded(), not(eq(variables['Build.Reason'], 'PullRequest')))
    jobs:
      - template: ./templates/console-ci-helix-job.yml
        parameters:
          platform: x64

  - stage: Scripts
    displayName: Code Health Scripts
    dependsOn: []
    condition: succeeded()
    jobs:
      - template: ./templates/check-formatting.yml

